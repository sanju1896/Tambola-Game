<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° TAMBOLA MASTER ULTIMATE - Lifetime Free Offline</title>
    <style>
        :root {
            --primary: #667eea;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #222;
            --light: #f5f5f5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .header h1 { font-size: 24px; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; margin-bottom: 8px; }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .stat {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 11px;
        }

        .stat-val { font-size: 18px; font-weight: bold; margin-top: 3px; }

        .call-box {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .call-box input {
            font-size: 36px;
            font-weight: bold;
            padding: 12px;
            border: 3px solid var(--primary);
            border-radius: 8px;
            width: 120px;
            text-align: center;
            outline: none;
        }

        .call-info {
            flex: 1;
            font-weight: bold;
            color: var(--primary);
            font-size: 13px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.1s;
            white-space: nowrap;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { transform: scale(0.95); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-secondary { background: #666; color: white; }

        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            font-weight: bold;
            animation: slideInAlert 0.4s;
            max-width: 300px;
        }

        @keyframes slideInAlert {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-title { font-size: 16px; margin-bottom: 5px; }
        .alert-content { font-size: 13px; line-height: 1.4; }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: white;
            padding: 8px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 6px;
        }

        .called-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
        }

        .called-num {
            background: var(--primary);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
        }

        .prizes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .prize {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #ddd;
            background: white;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .prize.available {
            border-color: var(--success);
            background: #e8f5e9;
            color: #2e7d32;
        }

        .prize.claimed {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            border-color: #ff6b6b;
            box-shadow: 0 3px 10px rgba(255,107,107,0.3);
            animation: pulse 2s infinite;
        }

        .prize-alert {
            font-size: 10px;
            margin-top: 3px;
            opacity: 0.8;
            text-align: center;
            word-break: break-word;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
            margin: 10px 0;
            max-height: 700px;
            overflow-y: auto;
        }

        .sheet {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-size: 10px;
            position: relative;
            transition: all 0.15s;
        }

        .sheet:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sheet.completed { background: #e8f5e9; border-color: var(--success); }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .sheet-num {
            color: var(--primary);
            font-size: 14px;
            font-weight: bold;
        }

        .sheet-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 1px;
            margin-bottom: 6px;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

        .cell.marked { background: #ff9800; color: white; border-color: #ff9800; }
        .cell.empty { background: #f0f0f0; border: 1px dashed #ddd; }

        .ticket-sep {
            height: 2px;
            background: #ddd;
            margin: 4px 0;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196F3;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1999;
        }

        .celebration-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            animation: celebBounce 0.5s;
            z-index: 2001;
        }

        @keyframes celebBounce {
            0%, 100% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
        }

        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .modal-body { margin-bottom: 15px; }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .drag-area {
            border: 3px dashed var(--primary);
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
        }

        .drag-area.over { background: var(--light); border-color: #5568d3; }

        .storage-info {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .prizes-grid { grid-template-columns: repeat(2, 1fr); }
            .sheets-grid { grid-template-columns: 1fr; }
            button { padding: 10px 14px; font-size: 13px; }
            .call-box input { font-size: 28px; width: 90px; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>‚ö° TAMBOLA MASTER ULTIMATE</h1>
        <p>üíæ Lifetime Free | ‚ö° Light Speed | üîí Zero Server | üì± Offline Forever</p>
        <div class="stats">
            <div class="stat">
                <div>üìû Called</div>
                <div class="stat-val" id="stat-called">0</div>
            </div>
            <div class="stat">
                <div>üèÜ Prizes</div>
                <div class="stat-val" id="stat-prizes">0/9</div>
            </div>
            <div class="stat">
                <div>üìã Sheets</div>
                <div class="stat-val" id="stat-sheets">0</div>
            </div>
            <div class="stat">
                <div>‚úÖ Done</div>
                <div class="stat-val" id="stat-done">0</div>
            </div>
        </div>
        <div class="storage-info" id="storage-info">üíæ Auto-saving...</div>
    </div>

    <!-- CALL INPUT BOX -->
    <div class="call-box">
        <input type="number" id="callInput" min="1" max="90" placeholder="1-90" autofocus>
        <div class="call-info">PRESS ENTER</div>
        <div class="btn-group" style="margin-left: auto;">
            <button class="btn-primary" onclick="callRandom()">üé≤ RANDOM</button>
            <button class="btn-warning" onclick="undoLast()">‚Ü∂ UNDO</button>
            <button class="btn-danger" onclick="resetGame()">üîÑ RESET</button>
            <button class="btn-secondary" onclick="downloadGame()">üíæ SAVE</button>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('game')">üéÆ GAME</button>
        <button class="tab-btn" onclick="switchTab('sheets')">üìã SHEETS</button>
        <button class="tab-btn" onclick="switchTab('prizes')">üèÜ PRIZES</button>
        <button class="tab-btn" onclick="switchTab('history')">üìú HISTORY</button>
    </div>

    <!-- GAME TAB -->
    <div id="game" class="tab-content active">
        <div class="section">
            <div class="section-title">üìû Called Numbers</div>
            <div class="called-box" id="calledBox">
                <span style="color: #999;">No numbers called</span>
            </div>
        </div>

        <div class="section">
            <div class="btn-group">
                <div style="position: relative; flex: 1;">
                    <button class="btn-primary" style="width: 100%;">üìÅ LOAD JSON</button>
                    <input type="file" accept=".json" onchange="loadJSON(event)" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                </div>
                <button class="btn-success" onclick="loadSample()">üì¶ SAMPLE</button>
                <button class="btn-primary" onclick="generateModal()">‚ûï GEN</button>
            </div>
            <div id="alertBox"></div>
        </div>
    </div>

    <!-- SHEETS TAB -->
    <div id="sheets" class="tab-content">
        <div class="section">
            <div class="section-title">üìã Sheets Management</div>
            <div class="drag-area" id="dragArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                üìÅ Drag JSON or click to load
            </div>
            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn-secondary" onclick="selectAllSheets()">‚òëÔ∏è SELECT ALL</button>
                <button class="btn-danger" onclick="deleteSelected()">üóëÔ∏è DELETE</button>
            </div>
        </div>

        <div class="section">
            <div class="sheets-grid" id="sheetsGrid">
                <p style="grid-column: 1/-1; text-align: center; color: #999;">No sheets loaded</p>
            </div>
        </div>
    </div>

    <!-- PRIZES TAB -->
    <div id="prizes" class="tab-content">
        <div class="section">
            <div class="section-title">üèÜ 9 Prizes Status</div>
            <div class="prizes-grid" id="prizesGrid"></div>
        </div>
    </div>

    <!-- HISTORY TAB -->
    <div id="history" class="tab-content">
        <div class="section">
            <div class="section-title">üìú Prize History</div>
            <div id="historyBox" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #999;">No prizes claimed</p>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="generateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Generate Sheets</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Count:</label>
                    <input type="number" id="genCount" min="1" max="100" value="6">
                </div>
                <div class="form-group">
                    <label>Start Number:</label>
                    <input type="number" id="genStart" min="1" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('generateModal')">Cancel</button>
                <button class="btn-success" onclick="confirmGenerate()">Generate</button>
            </div>
        </div>
    </div>

    <!-- CELEBRATION -->
    <div id="celebration" class="celebration"></div>

    <!-- ALERT NOTIFICATION -->
    <div id="alertNotif" class="alert-notification hidden">
        <div class="alert-title" id="alertTitle"></div>
        <div class="alert-content" id="alertContent"></div>
    </div>

    <script>
        // =================== STATE ===================
        const state = {
            called: new Set(),
            sheets: [],
            prizes: {
                'early5': { name: 'üîî Early 5', claimed: null, sheet: null, needNum: 5, alert: false },
                'top-line': { name: 'Top Line', claimed: null, sheet: null, alert: false },
                'mid-line': { name: 'Middle Line', claimed: null, sheet: null, alert: false },
                'bot-line': { name: 'Bottom Line', claimed: null, sheet: null, alert: false },
                'corner': { name: 'Ticket Corner', claimed: null, sheet: null, alert: false },
                'sheet-corner': { name: 'Sheet Corner', claimed: null, sheet: null, alert: false },
                'tree': { name: 'Tambola Tree', claimed: null, sheet: null, alert: false },
                'full': { name: 'üéä FULL HOUSE', claimed: null, sheet: null, needNum: 15, alert: false },
                'full2': { name: 'üéä 2ND FULL HOUSE', claimed: null, sheet: null, needNum: 15, alert: false }
            },
            prizeHist: [],
            undo: [],
            selected: new Set()
        };

        // =================== INIT ===================
        document.addEventListener('DOMContentLoaded', () => {
            loadFromStorage();
            renderAll();

            document.getElementById('callInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const num = parseInt(e.target.value);
                    if (!isNaN(num) && num >= 1 && num <= 90 && !state.called.has(num)) {
                        callNumberFast(num);
                        e.target.value = '';
                    }
                }
            });

            setInterval(saveToStorage, 3000);
        });

        // =================== ULTRA FAST CALL ===================
        function callNumberFast(num) {
            // SAVE UNDO STATE
            state.undo.push({
                called: new Set(state.called),
                sheets: JSON.parse(JSON.stringify(state.sheets)),
                prizes: JSON.parse(JSON.stringify(state.prizes)),
                prizeHist: JSON.parse(JSON.stringify(state.prizeHist))
            });

            if (state.undo.length > 30) state.undo.shift();

            // INSTANT MARK
            state.called.add(num);
            for (let s of state.sheets) {
                for (let t of s.tickets) {
                    for (let r = 0; r < 3; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (t[r][c] === num) t[r][c] = -num;
                        }
                    }
                }
            }

            // CHECK PRIZES
            checkAllPrizes(num);

            // INSTANT RENDER
            renderCalledNumbers();
            renderSheets();
            updateStats();
            saveToStorage();

            document.getElementById('callInput').focus();
        }

        // =================== ALERT NOTIFICATION ===================
        function showPrizeAlert(title, content) {
            const notif = document.getElementById('alertNotif');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertContent').textContent = content;
            notif.classList.remove('hidden');

            setTimeout(() => {
                notif.classList.add('hidden');
            }, 5000);
        }

        // =================== CHECK NEEDED NUMBER ===================
        function checkAllPrizes(lastNum) {
            const unclaimed = Object.keys(state.prizes).filter(k => !state.prizes[k].claimed);
            if (unclaimed.length === 0) return;

            for (let si = 0; si < state.sheets.length; si++) {
                const sheet = state.sheets[si];
                const snum = sheet.num;

                // CHECK FULL HOUSE NEEDS
                for (let ti = 0; ti < sheet.tickets.length; ti++) {
                    const ticket = sheet.tickets[ti];
                    const markedCount = ticket.flat().filter(n => n < 0).length;

                    // FULL HOUSE - NEEDS 1 MORE?
                    if (!state.prizes['full'].claimed && markedCount === 14) {
                        const emptyNum = findEmptyNumber(ticket);
                        if (emptyNum && emptyNum !== lastNum) {
                            showPrizeAlert(
                                'üéä FULL HOUSE ALERT!',
                                `Sheet ${snum}: Need ${emptyNum} to FULL HOUSE`
                            );
                        }
                    }

                    // 2ND FULL HOUSE - NEEDS 1 MORE?
                    if (state.prizes['full'].claimed && !state.prizes['full2'].claimed && markedCount === 14) {
                        const emptyNum = findEmptyNumber(ticket);
                        if (emptyNum && emptyNum !== lastNum && snum !== state.prizes['full'].sheet) {
                            showPrizeAlert(
                                'üéä 2ND FULL HOUSE ALERT!',
                                `Sheet ${snum}: Need ${emptyNum} for 2nd FULL HOUSE`
                            );
                        }
                    }

                    // EARLY 5 - NEEDS 1 MORE?
                    if (!state.prizes['early5'].claimed && markedCount === 4) {
                        const emptyNum = findEmptyNumber(ticket);
                        if (emptyNum && emptyNum !== lastNum) {
                            showPrizeAlert(
                                'üîî EARLY 5 ALERT!',
                                `Sheet ${snum}: Need ${emptyNum} for Early 5`
                            );
                        }
                    }
                }

                // INSTANT PRIZE CLAIM
                for (let ti = 0; ti < sheet.tickets.length; ti++) {
                    const ticket = sheet.tickets[ti];
                    const markedCount = ticket.flat().filter(n => n < 0).length;

                    if (!state.prizes['early5'].claimed && markedCount === 5) {
                        claimPrize('early5', snum, lastNum);
                    }
                    if (!state.prizes['top-line'].claimed && checkLine(ticket, 0)) {
                        claimPrize('top-line', snum, lastNum);
                    }
                    if (!state.prizes['mid-line'].claimed && checkLine(ticket, 1)) {
                        claimPrize('mid-line', snum, lastNum);
                    }
                    if (!state.prizes['bot-line'].claimed && checkLine(ticket, 2)) {
                        claimPrize('bot-line', snum, lastNum);
                    }
                    if (!state.prizes['corner'].claimed && checkCorner(ticket)) {
                        claimPrize('corner', snum, lastNum);
                    }
                    if (markedCount === 15) {
                        if (!state.prizes['full'].claimed) {
                            claimPrize('full', snum, lastNum);
                        } else if (!state.prizes['full2'].claimed && snum !== state.prizes['full'].sheet) {
                            claimPrize('full2', snum, lastNum);
                        }
                    }
                }

                if (!state.prizes['sheet-corner'].claimed && checkSheetCorner(sheet)) {
                    claimPrize('sheet-corner', snum, lastNum);
                }
                if (!state.prizes['tree'].claimed && checkTree(sheet)) {
                    claimPrize('tree', snum, lastNum);
                }
            }
        }

        function findEmptyNumber(ticket) {
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 9; c++) {
                    if (ticket[r][c] > 0) return ticket[r][c];
                }
            }
            return null;
        }

        function checkLine(ticket, row) {
            const line = ticket[row];
            const filled = line.filter(n => n !== 0);
            return filled.length > 0 && filled.every(n => n < 0);
        }

        function checkCorner(ticket) {
            return ticket[0][0] < 0 && ticket[0][8] < 0 && ticket[2][0] < 0 && ticket[2][8] < 0;
        }

        function checkSheetCorner(sheet) {
            return sheet.tickets[0][0][0] < 0 && sheet.tickets[0][0][8] < 0 &&
                   sheet.tickets[sheet.tickets.length-1][2][0] < 0 &&
                   sheet.tickets[sheet.tickets.length-1][2][8] < 0;
        }

        function checkTree(sheet) {
            return sheet.tickets.every(t => t[0][0] < 0);
        }

        function claimPrize(id, snum, num) {
            if (state.prizes[id].claimed) return;

            state.prizes[id].claimed = true;
            state.prizes[id].sheet = snum;

            state.prizeHist.push({
                prize: state.prizes[id].name,
                sheet: snum,
                number: num,
                time: new Date().toLocaleTimeString()
            });

            // CELEBRATION
            celebrate(`üèÜ ${state.prizes[id].name}!
üìã Sheet #${snum}`);

            showPrizeAlert(
                `üéâ ${state.prizes[id].name}!`,
                `üìã Sheet ${snum} | üìû Number ${num}`
            );

            renderAll();
        }

        // =================== CELEBRATE ===================
        function celebrate(text) {
            const box = document.getElementById('celebration');
            box.innerHTML = `<div class="celebration-box">${text}</div>`;

            for (let i = 0; i < 50; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.background = ['#ff6b6b', '#4CAF50', '#2196F3', '#FFC107'][Math.floor(Math.random() * 4)];
                box.appendChild(conf);
            }

            setTimeout(() => { box.innerHTML = ''; }, 2500);
        }

        // =================== UNDO WITH MULTI-LEVEL ===================
        function undoLast() {
            if (state.undo.length === 0) {
                showAlert('Nothing to undo!', 'danger');
                return;
            }

            const prev = state.undo.pop();
            const lastCalledNum = Array.from(state.called).pop();

            state.called = prev.called;
            state.sheets = prev.sheets;
            state.prizes = prev.prizes;
            state.prizeHist = prev.prizeHist;

            renderAll();
            saveToStorage();

            if (lastCalledNum) {
                showAlert(`‚Ü∂ Undo: Removed number ${lastCalledNum}`, 'info');
            }
        }

        // =================== RENDER FUNCTIONS ===================
        function renderAll() {
            renderCalledNumbers();
            renderSheets();
            renderPrizes();
            updateHistoryUI();
            updateStats();
        }

        function renderCalledNumbers() {
            const box = document.getElementById('calledBox');
            if (state.called.size === 0) {
                box.innerHTML = '<span style="color: #999;">No numbers called</span>';
                return;
            }
            const sorted = Array.from(state.called).sort((a, b) => a - b);
            box.innerHTML = sorted.map(n => `<span class="called-num">${n}</span>`).join('');
        }

        function renderSheets() {
            const grid = document.getElementById('sheetsGrid');
            if (state.sheets.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">No sheets loaded</p>';
                return;
            }

            const html = state.sheets.map((s, si) => {
                const isDone = s.tickets.every(t => t.every(r => r.every(c => c === 0 || c < 0)));

                let ticketsHtml = '';
                for (let ti = 0; ti < s.tickets.length; ti++) {
                    const ticket = s.tickets[ti];
                    const cellsHtml = ticket.flat().map(c => {
                        const marked = c < 0 ? 'marked' : '';
                        const empty = c === 0 ? 'empty' : '';
                        const num = Math.abs(c);
                        return `<div class="cell ${marked} ${empty}">${empty ? '' : num}</div>`;
                    }).join('');

                    ticketsHtml += `<div class="ticket-grid">${cellsHtml}</div>`;
                    if (ti < s.tickets.length - 1) ticketsHtml += '<div class="ticket-sep"></div>';
                }

                return `<div class="sheet ${isDone ? 'completed' : ''}">
                    <div class="sheet-header">
                        <span class="sheet-num">Sheet ${s.num}</span>
                        <input type="checkbox" class="sheet-checkbox" data-idx="${si}" style="cursor: pointer;">
                    </div>
                    ${ticketsHtml}
                </div>`;
            }).join('');

            grid.innerHTML = html;

            grid.querySelectorAll('.sheet-checkbox').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    if (e.target.checked) {
                        state.selected.add(idx);
                    } else {
                        state.selected.delete(idx);
                    }
                });
            });
        }

        function renderPrizes() {
            const grid = document.getElementById('prizesGrid');
            grid.innerHTML = Object.entries(state.prizes).map(([id, p]) => {
                let alertText = '';
                if (p.claimed) {
                    alertText = `<div class="prize-alert">Sheet ${p.sheet}</div>`;
                }
                return `<div class="prize ${p.claimed ? 'claimed' : 'available'}">
                    <div>${p.name}</div>
                    ${alertText}
                </div>`;
            }).join('');
        }

        function updateHistoryUI() {
            const box = document.getElementById('historyBox');
            if (state.prizeHist.length === 0) {
                box.innerHTML = '<p style="text-align: center; color: #999;">No prizes claimed</p>';
                return;
            }
            box.innerHTML = state.prizeHist.map((h, i) => `
                <div style="padding: 10px; background: #f0f0f0; margin-bottom: 8px; border-radius: 6px; font-size: 13px;">
                    <strong>#${i+1} ${h.prize}</strong><br>
                    üìã Sheet: ${h.sheet} | üìû #${h.number} | üïê ${h.time}
                </div>
            `).join('');
        }

        // =================== JSON LOADING ===================
        function loadJSON(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    const sheets = extractSheets(data);

                    if (sheets.length === 0) throw new Error('No valid sheets found');

                    state.sheets = sheets;
                    renderAll();
                    saveToStorage();
                    showAlert(`‚úÖ Loaded ${sheets.length} sheets!`, 'success');
                    e.target.value = '';
                } catch (err) {
                    showAlert(`‚ùå Error: ${err.message}`, 'danger');
                }
            };
            reader.readAsText(file);
        }

        function extractSheets(data) {
            const sheets = [];

            const processTicket = (ticket) => {
                let numbers = null;

                if (Array.isArray(ticket) && Array.isArray(ticket[0])) {
                    numbers = ticket;
                } else if (ticket.numbers && Array.isArray(ticket.numbers)) {
                    numbers = ticket.numbers;
                } else if (ticket.ticketNumbers) {
                    numbers = ticket.ticketNumbers;
                }

                if (!numbers || numbers.length === 0) return null;

                const rows = [];
                for (let r = 0; r < 3; r++) {
                    const row = numbers[r] || new Array(9).fill(0);
                    const normalized = [];
                    for (let c = 0; c < 9; c++) {
                        normalized.push(row[c] || 0);
                    }
                    rows.push(normalized);
                }
                return rows;
            };

            const process = (raw) => {
                if (!raw || !raw.tickets) return null;
                if (!Array.isArray(raw.tickets) || raw.tickets.length === 0) return null;

                const num = String(raw.sheetNumber !== undefined ? raw.sheetNumber : 
                           raw.number !== undefined ? raw.number : raw.id || 1);

                const tickets = [];
                for (let ticket of raw.tickets) {
                    const processed = processTicket(ticket);
                    if (processed) tickets.push(processed);
                }

                return tickets.length > 0 ? { num, tickets } : null;
            };

            if (Array.isArray(data)) {
                data.forEach(item => {
                    const s = process(item);
                    if (s) sheets.push(s);
                });
            } else if (data.sheets && Array.isArray(data.sheets)) {
                data.sheets.forEach(item => {
                    const s = process(item);
                    if (s) sheets.push(s);
                });
            } else if (data.data && Array.isArray(data.data)) {
                data.data.forEach(item => {
                    const s = process(item);
                    if (s) sheets.push(s);
                });
            }

            return sheets;
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('dragArea').classList.remove('over');
            const file = e.dataTransfer.files[0];
            if (file?.name.endsWith('.json')) {
                const input = document.createElement('input');
                input.type = 'file';
                input.files = e.dataTransfer.files;
                loadJSON({ target: input });
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('dragArea').classList.add('over');
        }

        function handleDragLeave() {
            document.getElementById('dragArea').classList.remove('over');
        }

        // =================== SHEET GENERATION ===================
        function generateModal() {
            document.getElementById('generateModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function confirmGenerate() {
            const count = parseInt(document.getElementById('genCount').value);
            const start = parseInt(document.getElementById('genStart').value);

            if (isNaN(count) || count < 1 || count > 100) {
                showAlert('1-100 sheets', 'danger');
                return;
            }

            for (let i = 0; i < count; i++) {
                state.sheets.push(genSheet(start + i));
            }

            renderAll();
            closeModal('generateModal');
            showAlert(`‚úÖ Generated ${count} sheets!`, 'success');
            saveToStorage();
        }

        function genSheet(num) {
            const tickets = [];
            for (let t = 0; t < 6; t++) {
                const rows = [];
                for (let r = 0; r < 3; r++) {
                    const row = [];
                    for (let c = 0; c < 9; c++) {
                        if (Math.random() < 0.55) {
                            const min = c * 10 + 1;
                            const max = Math.min((c + 1) * 10, 90);
                            row.push(Math.floor(Math.random() * (max - min + 1)) + min);
                        } else {
                            row.push(0);
                        }
                    }
                    rows.push(row);
                }
                tickets.push(rows);
            }
            return { num: String(num), tickets };
        }

        function loadSample() {
            state.sheets = [];
            for (let i = 1; i <= 6; i++) {
                state.sheets.push(genSheet(i));
            }
            renderAll();
            saveToStorage();
        }

        // =================== STORAGE ===================
        function saveToStorage() {
            try {
                const data = {
                    called: Array.from(state.called),
                    sheets: state.sheets,
                    prizes: state.prizes,
                    prizeHist: state.prizeHist,
                    saved: Date.now()
                };
                localStorage.setItem('tambola_ultimate', JSON.stringify(data));
                updateStorageStatus();
            } catch (e) {
                console.warn('Storage error');
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('tambola_ultimate');
                if (data) {
                    const saved = JSON.parse(data);
                    state.called = new Set(saved.called || []);
                    state.sheets = saved.sheets || [];
                    state.prizes = saved.prizes || state.prizes;
                    state.prizeHist = saved.prizeHist || [];
                    if (state.sheets.length > 0) {
                        showAlert(`‚úÖ Loaded ${state.sheets.length} sheets!`, 'success');
                    }
                }
            } catch (e) {
                console.warn('Load error');
            }
        }

        function downloadGame() {
            const data = {
                exported: new Date().toISOString(),
                called: Array.from(state.called),
                sheets: state.sheets,
                prizes: state.prizes,
                prizeHistory: state.prizeHist,
                software: 'TAMBOLA MASTER ULTIMATE - Lifetime Free Edition',
                version: '3.0'
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `tambola_game_${new Date().toISOString().split('T')[0]}.json`;
            a.click();

            URL.revokeObjectURL(url);
            showAlert('üíæ Game saved!', 'success');
        }

        function updateStorageStatus() {
            const info = document.getElementById('storage-info');
            const size = (JSON.stringify(state).length / 1024).toFixed(1);
            info.textContent = `‚úì Auto-saved ‚Ä¢ ${size}KB ‚Ä¢ ${state.sheets.length} sheets ‚Ä¢ ${state.called.size} called`;
        }

        // =================== CONTROLS ===================
        function selectAllSheets() {
            document.querySelectorAll('.sheet-checkbox').forEach(cb => {
                cb.checked = true;
                state.selected.add(parseInt(cb.dataset.idx));
            });
        }

        function deleteSelected() {
            if (state.selected.size === 0) {
                showAlert('Select sheets first', 'danger');
                return;
            }

            state.undo.push({
                called: new Set(state.called),
                sheets: JSON.parse(JSON.stringify(state.sheets)),
                prizes: JSON.parse(JSON.stringify(state.prizes)),
                prizeHist: JSON.parse(JSON.stringify(state.prizeHist))
            });

            state.sheets = state.sheets.filter((_, i) => !state.selected.has(i));
            state.selected.clear();
            renderAll();
            saveToStorage();
        }

        function resetGame() {
            if (!confirm('Reset game? Sheets stay, numbers & prizes clear.')) return;

            state.undo.push({
                called: new Set(state.called),
                sheets: JSON.parse(JSON.stringify(state.sheets)),
                prizes: JSON.parse(JSON.stringify(state.prizes)),
                prizeHist: JSON.parse(JSON.stringify(state.prizeHist))
            });

            state.called = new Set();
            state.prizeHist = [];

            Object.keys(state.prizes).forEach(k => {
                state.prizes[k].claimed = null;
                state.prizes[k].sheet = null;
            });

            state.sheets.forEach(s => {
                s.tickets.forEach(t => {
                    t.forEach((r, ri) => {
                        r.forEach((c, ci) => {
                            if (c < 0) r[ci] = Math.abs(c);
                        });
                    });
                });
            });

            renderAll();
            document.getElementById('callInput').focus();
            saveToStorage();
        }

        function callRandom() {
            const available = [];
            for (let i = 1; i <= 90; i++) {
                if (!state.called.has(i)) available.push(i);
            }
            if (available.length === 0) {
                showAlert('All 90 numbers called!', 'danger');
                return;
            }
            const num = available[Math.floor(Math.random() * available.length)];
            callNumberFast(num);
        }

        // =================== UI ===================
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function updateStats() {
            const done = state.sheets.filter(s => 
                s.tickets.every(t => t.every(r => r.every(c => c === 0 || c < 0)))
            ).length;

            document.getElementById('stat-called').textContent = state.called.size;
            document.getElementById('stat-prizes').textContent = `${Object.values(state.prizes).filter(p => p.claimed).length}/9`;
            document.getElementById('stat-sheets').textContent = state.sheets.length;
            document.getElementById('stat-done').textContent = done;
        }

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => { box.innerHTML = ''; }, 3500);
        }
    </script>
</body>
</html>